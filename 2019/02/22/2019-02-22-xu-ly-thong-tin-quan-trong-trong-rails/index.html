<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Lưu Trữ Thông Tin Bảo Mật? | Chinh&#39;s Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Đặt vấn đềKhi còn Interns tại Framgia, trong một sản phẩm bắt buộc của chương trình thực tập, tôi còn nhớ, mentor đã yêu cầu tôi làm chức năng gửi mail cho ứng dụng rails. Đây thực sự là một task khó">
<meta name="keywords" content="rails,secure">
<meta property="og:type" content="article">
<meta property="og:title" content="Lưu Trữ Thông Tin Bảo Mật?">
<meta property="og:url" content="https:&#x2F;&#x2F;hdchinh.github.io&#x2F;2019&#x2F;02&#x2F;22&#x2F;2019-02-22-xu-ly-thong-tin-quan-trong-trong-rails&#x2F;index.html">
<meta property="og:site_name" content="Chinh&#39;s Notes">
<meta property="og:description" content="Đặt vấn đềKhi còn Interns tại Framgia, trong một sản phẩm bắt buộc của chương trình thực tập, tôi còn nhớ, mentor đã yêu cầu tôi làm chức năng gửi mail cho ứng dụng rails. Đây thực sự là một task khó">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-11-13T04:01:32.404Z">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Chinh&#39;s Notes" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Chinh&#39;s Notes</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://hdchinh.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-2019-02-22-xu-ly-thong-tin-quan-trong-trong-rails" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/02/22/2019-02-22-xu-ly-thong-tin-quan-trong-trong-rails/" class="article-date">
  <time datetime="2019-02-21T17:00:00.000Z" itemprop="datePublished">2019-02-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/rails-notes/">rails notes</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Lưu Trữ Thông Tin Bảo Mật?
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Dat-van-de"><a href="#Dat-van-de" class="headerlink" title="Đặt vấn đề"></a>Đặt vấn đề</h1><p>Khi còn Interns tại Framgia, trong một sản phẩm bắt buộc của chương trình thực tập, tôi còn nhớ, mentor đã yêu cầu tôi làm chức năng gửi mail cho ứng dụng rails. Đây thực sự là một task khó với một người non nớt kinh nghiệm như tôi khi đấy, mà ráng google một lát cũng tìm ra cách làm và áp dụng thành công, tạo PR lòng hân hoan, nào ngờ ngay sau đó tôi đã bị mentor mạt sát một trận kinh hoàng. Nguyên nhân là do trong lúc config môi trường để gửi mail, tôi đã để thông tin email của tôi vào file config và commit lên github, lúc đó nghĩ bụng cũng tức “Gì mà làm khó nhau quá vậy? Interns không lương thôi mà làm gì ghê, commit lên đó thì sao…”. Giờ thì hiển nhiên là tôi nhìn nhận được sai lầm đó, và hiểu được những hiểu biết mù mờ về config và bảo mật sẽ khiến ứng dụng của tôi dễ tan tành như thế nào. Ngoài thông tin như email, trong dự án của chúng ta đôi khi còn những thông tin vô cùng quan trọng như key của dịch vụ lưu trữ đám mây, thông tin đăng nhập bên thứ ba, hay một chuỗi bí ẩn được gọi dưới cái tên <code>secret_key</code>. Bài viết này sẽ trình bày về cách xử lý những thông tin nhạy cảm kể trên.</p>
<h1 id="Luan-ban"><a href="#Luan-ban" class="headerlink" title="Luận bàn"></a>Luận bàn</h1><h1 id="1-Khai-quat"><a href="#1-Khai-quat" class="headerlink" title="1. Khái quát"></a>1. Khái quát</h1><p>Bài toán này đơn giản hiểu như sau: Một project bất kỳ sẽ luôn có những thông tin cấu hình vô cùng quan trọng, bắt buộc phải luôn giữ chúng private, còn làm cách nào để giữ chúng private trong rails?<br>Câu trả lời là tuỳ vào mỗi phiên bản rails, sẽ có (có thể có) những cách khác nhau để xử lý vấn đề này. Hãy đi đến các dấu mốc cụ thể dưới đây.</p>
<h1 id="2-Rails-4-1"><a href="#2-Rails-4-1" class="headerlink" title="2. Rails 4.1"></a>2. Rails 4.1</h1><p>Phiên bản rails này sử dụng một file có tên <code>secrets.yml</code>, đây là file sẽ lưu toàn bộ các thông tin nhạy cảm chúng ta đã nói ở trên.<br>Với thiết kế như này ta có hai lựa chọn cho ứng dụng của mình:</p>
<ol>
<li><p>Đem hết thông tin nhạy cảm dưới đạng text bỏ vào file này, tuy nhiên file này phải được bỏ vào trong danh mục của <code>gitignore</code> để đảm bảo thông tin trong đó không bị bạn vô tình hay hữu ý commit đi đâu đó.</p>
</li>
<li><p>Thông tin nhạy cảm lưu trong file này thay vì được lưu dưới dạng text thì sẽ được lưu trong máy của bạn dứoi dạng <code>biến môi trường</code> và trong file <code>secrets.yml</code> chỉ sử dụng phương thức <code>ENV</code> mà rails cung cấp để gọi lại các thông tin đó lên, với lựa chọn này bạn có thể commit file này thoải mái, ở các máy tính đồng nghiệp, để có thể sử dụng được những config này thì buộc họ phải thiết lập biến môi trường trên máy tính của họ cho phù hợp.</p>
</li>
</ol>
<p>Nhược điểm: dù sử dụng cách nào, thì để ứng dụng hoạt động được thì vẫn phải truyền giá trị các thông tin nhạy cảm này từ máy của bạn lên một con vps khi triển khai chẳng hạn, không còn cách nào khác. Có thể bạn phải copy từng dòng thông tin nhạy cảm rồi paste qua remote shell để thiết lập (với những dự án lớn có rất nhiều thông tin quan trọng thì đây là 1 công việc vất vả tiềm tàng nguy cơ sai sót).</p>
<p>Note: Thay vì sử dụng file <code>secrets.yml</code>, ta có thể sử dụng một file khác như <code>application.yml</code>, mục đích và chức năng của chúng là tương đương.</p>
<h1 id="3-Rails-5-1"><a href="#3-Rails-5-1" class="headerlink" title="3. Rails 5.1"></a>3. Rails 5.1</h1><p>Sang đến phiên bản rails 5.1, một thay đổi lớn đã tới. Thay vì lưu thông tin dạng text hoặc triệu hồi thông qua biến môi trường, rails khi này cung cấp khả năng mã hoá cho các thông tin nhạy cảm này.<br>Cách chúng hoạt động như sau:</p>
<p>Một file tên <code>secrets.yml.key</code> sẽ chứa giá trị của một biến tên <code>RAILS_MASTER_KEY</code>, biến này có giá trị là một chuỗi, có chức năng được sử dụng để mã hoá và giải mã các thông tin quan trọng.</p>
<p>Nội dung thông tin <strong>sau</strong> mã hoá sẽ được lưu tại file <code>secrets.yml.enc</code></p>
<p>Vậy còn file <code>secrets.yml</code> trong rails 4 giờ còn không? Câu trả lời là bạn vẫn có thể sử dụng file này, tuy nhiên trên cùng một môi trường, nếu có cả file <code>secrets.yml</code> và <code>secrets.yml.enc</code> thì hai file này sẽ được merge.</p>
<p>Để có thể sử dụng tính năng encypt này của rails 5.1 ta setup như sau:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails <span class="symbol">secrets:</span>setup</span><br></pre></td></tr></table></figure>
<p>Sau câu lệnh này hai file <code>secrets.yml.key</code> và <code>secrets.yml.enc</code> sẽ được tạo ra. Để thêm xoá sửa nội dung trong <code>secrets.yml.enc</code> ta sử dụng lệnh sau:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails <span class="symbol">secrets:</span>edit</span><br></pre></td></tr></table></figure>

<p>Câu lệnh này sẽ mở nội dung file <code>secrets.yml.enc</code> dưới dạng đã giải mã. Bạn có thể thoải mái thêm xoá, sửa các thông tin nhạy cảm, sau đó khi bạn save lại và tắt editor thì file <code>secrets.yml.enc</code> sẽ tự động được cập nhập phần mã hoá mới nhất khi có thêm thông tin.</p>
<p>Tôi thích dùng <code>vim</code> để chỉnh sửa, và tôi không muốn set mặc định editor nên tôi sử dụng câu lệnh sau: <code>EDITOR=vi rails secrets:edit</code>.</p>
<p>Ưu điểm:</p>
<ol>
<li><p>Thay vì phải quản lý nhiều biến môi trường, giờ đây mọi thứ đều nằm trong một file.</p>
</li>
<li><p>Việc có thể commit <code>secrets.yml.enc</code> giúp chúng ta nắm được lịch sử thay đổi của file này.</p>
</li>
</ol>
<p>Note: Một điểm quan trọng bạn cần lưu ý, đó là tới khi viết bài viết này thì tôi vẫn chưa thấy rails sẽ giải mã thông tin mã hoá trong file <code>secrets.yml.enc</code>, chúng ta buộc phải làm thủ công để nhắc rails làm điều đó bằng cách thêm vào config file của bạn <code>config.read_encrypted_secrets = true</code>. Với câu lệnh setup bên trên, dòng config trên đã được add vào file config của production. Nếu bạn muốn sử dụng tính năng này cho môi trường development thì hãy thêm dòng config này vào file <code>config/environments/development.rb</code>.</p>
<h1 id="3-Rails-5-2"><a href="#3-Rails-5-2" class="headerlink" title="3. Rails 5.2"></a>3. Rails 5.2</h1><p>Ý tưởng trong rails 5.2 không thay đổi nhiều so với rails 5.1. Nhưng thay vì lưu key để encrypt/decrypt trong file secrets.yml.key giờ nó được lưu trong file <code>master.key</code> (tuy nhiên nếu không sử dụng file thì cả rails 5.2 và 5.1 đều có thể gọi biến môi trường RAILS_MASTER_KEY để sử dụng).</p>
<p>File lưu thông tin đã được mã hoá cũng được thay đổi từ secrets.yml.enc thành <code>credentials.yml.enc</code>.  Đó là những điểm khác biệt duy nhất.</p>
<p>Để chỉnh sửa thông tin trong file mã hoá ta sử dụng lệnh:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EDITOR=vi rails <span class="symbol">credentials:</span>edit</span><br></pre></td></tr></table></figure>
<p>Không cần dùng lệnh setup như trên, vì trong rails 5.2, hai file key và mã hoá được sinh ra cùng project.</p>
<p>Ta có thể truy xuất giá trị được giải mã trong file <code>credentials.yml.enc</code> như sau:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rails.application.credentials.ten_bien_trong_credentials</span><br></pre></td></tr></table></figure>

<p>Làm gì khi bạn muốn thay thế <code>master.key</code>?</p>
<ol>
<li><p><code>rails credentials:show</code> dùng lệnh này để hiển thị thông tin dạng giải mã ra editor, copy chúng.</p>
</li>
<li><p>Xoá hai file <code>master.key</code> và <code>credentials.yml.enc</code> đi.</p>
</li>
<li><p><code>EDITOR=vim rails credentials:edit</code> với lệnh sau bạn sẽ generate lại hai file mới. Việc cần làm bây giờ là paste thông tin ở bước 1 vào editor khi này rồi save lại.</p>
</li>
</ol>
<h1 id="4-secret-key-base"><a href="#4-secret-key-base" class="headerlink" title="4. secret_key_base"></a>4. secret_key_base</h1><p>Nếu làm theo hướng dẫn bên trên, ta sẽ thu được một file mã hoá ví dụ: <code>credentials.yml.enc</code> có chứa nội dung ngay cả khi ta mới vừa khởi tạo project. Điều gì đã xảy ra? Tôi còn chưa kịp edit thì nó lấy thông tin gì mà mã hoá ra nội dung đó vậy? Câu trả lời là một thứ được tạo kèm project của bạn có tên là <code>secret_key_base</code> sẽ là thứ đầu tiên được tự động lưu mã hoá vào file <code>credentials.yml.enc</code>.</p>
<p>Sao lại phức tạp như vậy? nó với <code>RAILS_MASTER_KEY</code> ở trên có quan hệ gì không? Câu trả lời là không? <code>secret_key_base</code> được rails sinh ra khi tạo project, nó đảm bảo rằng không thể có hai ứng dụng rails có chung một <code>secet_key_base</code>, cái key sẽ được sử dụng để đảo bảo thứ đánh dấu tính duy nhất của một project và nó còn được dùng làm nhiều việc hay ho khác tôi sẽ trình bày trong các bài viết sắp tới.</p>
<p>Để tạo ra một secret_key_base bạn có thể sử dụng lệnh sau:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails secret</span><br></pre></td></tr></table></figure>

<h1 id="Ket-luan"><a href="#Ket-luan" class="headerlink" title="Kết luận"></a>Kết luận</h1><p>Hãy để lại bình luận bên dưới nếu bạn có ý kiến khác hoặc phản hồi về nội dung bài viết nhé.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hdchinh.github.io/2019/02/22/2019-02-22-xu-ly-thong-tin-quan-trong-trong-rails/" data-id="ck2wvjj9r000mgyrz05zlcluo" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rails/" rel="tag">rails</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/secure/" rel="tag">secure</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/02/22/2019-02-22-quy-luat-80-20/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Quy Luật 80/20
        
      </div>
    </a>
  
  
    <a href="/2019/02/20/2019-02-20-cac-trinh-thong-dich-trong-ruby/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Vài Trình Thông Dịch Cho Ruby</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Random/">Random</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/he-dieu-hanh/">hệ điều hành</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/rails-notes/">rails notes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ruby-notes/">ruby notes</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/ruby-notes/programming/">programming</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/til/">til</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/TIl/" rel="tag">TIl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/activerecord/" rel="tag">activerecord</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aws/" rel="tag">aws</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/carrierwave/" rel="tag">carrierwave</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/database/" rel="tag">database</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/https/" rel="tag">https</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/orm/" rel="tag">orm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/programming/" rel="tag">programming</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rack/" rel="tag">rack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rails/" rel="tag">rails</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/random/" rel="tag">random</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ruby/" rel="tag">ruby</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/secure/" rel="tag">secure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/solid/" rel="tag">solid</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/til/" rel="tag">til</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unix/" rel="tag">unix</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/TIl/" style="font-size: 12px;">TIl</a> <a href="/tags/activerecord/" style="font-size: 10px;">activerecord</a> <a href="/tags/aws/" style="font-size: 12px;">aws</a> <a href="/tags/carrierwave/" style="font-size: 10px;">carrierwave</a> <a href="/tags/database/" style="font-size: 10px;">database</a> <a href="/tags/https/" style="font-size: 10px;">https</a> <a href="/tags/orm/" style="font-size: 10px;">orm</a> <a href="/tags/programming/" style="font-size: 12px;">programming</a> <a href="/tags/rack/" style="font-size: 10px;">rack</a> <a href="/tags/rails/" style="font-size: 18px;">rails</a> <a href="/tags/random/" style="font-size: 10px;">random</a> <a href="/tags/ruby/" style="font-size: 20px;">ruby</a> <a href="/tags/secure/" style="font-size: 16px;">secure</a> <a href="/tags/solid/" style="font-size: 10px;">solid</a> <a href="/tags/til/" style="font-size: 14px;">til</a> <a href="/tags/unix/" style="font-size: 16px;">unix</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/11/12/hello-hexo/">Hello Hexo1!</a>
          </li>
        
          <li>
            <a href="/2019/09/20/2019-09-20-vscode-extension/">My Favourite Vscode Extensions</a>
          </li>
        
          <li>
            <a href="/2019/08/05/2019-08-05-setup-terminal-macos/">Terminal macOS Tricks</a>
          </li>
        
          <li>
            <a href="/2019/06/26/2019-06-25-xay-dung-mot-orm-don-gian-bang-ruby/">A Simple ORM</a>
          </li>
        
          <li>
            <a href="/2019/06/24/2019-06-24-simple-rack-application/">A Simple Rack Application</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Duy Chinh<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>
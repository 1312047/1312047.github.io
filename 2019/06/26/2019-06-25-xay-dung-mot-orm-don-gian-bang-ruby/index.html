<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>A Simple ORM | Chinh&#39;s Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="1. Đặt vấn đềRails có phải là một framework tuyệt vời hay không? Chắc chắn là có rồi, với tôi là như vậy, mặc dù nó tốn Ram quá nhiều và chạy cũng hơi chậm, mọi thứ khác thật sự tuyệt vời. Nếu cần phả">
<meta name="keywords" content="ruby,orm">
<meta property="og:type" content="article">
<meta property="og:title" content="A Simple ORM">
<meta property="og:url" content="https:&#x2F;&#x2F;hdchinh.github.io&#x2F;2019&#x2F;06&#x2F;26&#x2F;2019-06-25-xay-dung-mot-orm-don-gian-bang-ruby&#x2F;index.html">
<meta property="og:site_name" content="Chinh&#39;s Notes">
<meta property="og:description" content="1. Đặt vấn đềRails có phải là một framework tuyệt vời hay không? Chắc chắn là có rồi, với tôi là như vậy, mặc dù nó tốn Ram quá nhiều và chạy cũng hơi chậm, mọi thứ khác thật sự tuyệt vời. Nếu cần phả">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-11-13T04:10:35.897Z">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Chinh&#39;s Notes" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Chinh&#39;s Notes</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://hdchinh.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-2019-06-25-xay-dung-mot-orm-don-gian-bang-ruby" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/26/2019-06-25-xay-dung-mot-orm-don-gian-bang-ruby/" class="article-date">
  <time datetime="2019-06-25T17:00:00.000Z" itemprop="datePublished">2019-06-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/rails-notes/">rails notes</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      A Simple ORM
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="1-Dat-van-de"><a href="#1-Dat-van-de" class="headerlink" title="1. Đặt vấn đề"></a>1. Đặt vấn đề</h1><p>Rails có phải là một framework tuyệt vời hay không? Chắc chắn là có rồi, với tôi là như vậy, mặc dù nó tốn Ram quá nhiều và chạy cũng hơi chậm, mọi thứ khác thật sự tuyệt vời.</p>
<p>Nếu cần phải xây dựng một ứng dụng CRUD, có lẽ Rails sẽ là một lựa chọn hàng đầu, vì thời gian xây dựng nhanh chóng để cho ra một sản phẩm tuy không phải là “ích seo lừn” nhưng cũng đủ good để work production.</p>
<p>Một trong những yếu tố làm cho Rails xây dựng các ứng dụng một cách nhanh chóng như vậy chính là gem ActiveRecord, một ORM mặc định và vô cùng mạnh mẽ trong Rails.</p>
<p>Như nhiều người khác, khi mới tiếp cận Framework này, tôi cũng sử dụng các lệnh command, các phương thức được support mà cũng không quan tâm đến cách mà nó vận hành.</p>
<p>Nhưng nghĩ đi nghĩ lại thấy cũng kì, làm mà không hiểu kì cục lắm :smile:</p>
<p>Vậy thôi, chúng ta hãy cùng thử xây dựng một ORM rất đơn giản, để coi thử magic gì đã xảy ra sau mỗi dòng lệnh.</p>
<h1 id="2-Ma-nguon"><a href="#2-Ma-nguon" class="headerlink" title="2. Mã nguồn"></a>2. Mã nguồn</h1><blockquote>
<p>Mã nguồn của ứng dụng này, bạn có thể tham khảo <a href="https://github.com/hdchinh/simple-orm-ruby" target="_blank" rel="noopener">tại đây</a></p>
</blockquote>
<h1 id="3-Giai-thich"><a href="#3-Giai-thich" class="headerlink" title="3. Giải thích"></a>3. Giải thích</h1><p>Note: Trước hết chúng ta nên đọc trước về định nghĩa của ORM <a href="https://en.wikipedia.org/wiki/Object-relational_mapping" target="_blank" rel="noopener">tại đây</a></p>
<p>Để xây dựng 1 ORM và chạy một vài ví dụ đơn giản được thì chúng ta có 2 nhiềm vụ phải làm:</p>
<ul>
<li><p>Kết nối với cơ sở dữ liệu (ở đây là postgresql).</p>
</li>
<li><p>Xây dựng các class bằng Ruby với các phương thức tương ứng để xử lý trên cơ sở dữ liệu đã kết nối ở bước 1.</p>
</li>
</ul>
<p><strong>STEP 1: Tạo project</strong></p>
<p>Tạo một project trống với 1 file Gemfile có nội dung như sau:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">source <span class="string">'https://rubygems.org'</span></span><br><span class="line"></span><br><span class="line">gem <span class="string">'pg'</span></span><br></pre></td></tr></table></figure>

<p>Cài đặt gem bằng lệnh: <code>bundle install</code>.</p>
<p>Nếu có lỗi xảy ra hãy tham khảo các tài liệu về cài đặt và sử dụng gem bundler.</p>
<p><strong>STEP 2: Kết nối cơ sở dữ liệu.</strong></p>
<p>Khi bắt đầu và quen thuộc với việc sử dụng command trong rails, việc duy nhất chúng ta còn thực sự sử dụng đó là sửa file <code>database.yml</code>, và đó là tất cả những gì cần thiết để đem ứng dụng của chúng ta kết nối với 1 hệ quản trị cơ sở dữ liệu nào đó trên máy. (Thực ra là vẫn còn nhiều điều xảy ra lắm, nhưng hãy cứ tạm chấp nhận như vậy).</p>
<p>Nhưng nếu không sử dụng Framework Rails, trong trường hợp này, khi tôi kết nối với Postgresql thì tôi sẽ sử dụng một gem tên <code>pg</code> đã cài đặt ở bước 1, và require nó vào file <code>connection.rb</code> có tác dụng kết nối như sau:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'pg'</span></span><br><span class="line"></span><br><span class="line">$conn = PG::Connection.connect(</span><br><span class="line">  <span class="symbol">:hostaddr=&gt;<span class="string">"127.0.0.1"</span></span>, <span class="symbol">:port=&gt;</span><span class="number">5432</span>,</span><br><span class="line">  <span class="symbol">:dbname=&gt;<span class="string">"test-psql_development"</span></span>,</span><br><span class="line">  <span class="symbol">:user=&gt;<span class="string">"admin"</span></span>,</span><br><span class="line">  <span class="symbol">:password=&gt;<span class="string">''</span></span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>Note: Bạn cần thay đổi các giá trị ở trên để phù hợp với database mà bạn muốn kết nối trên máy của bạn.</p>
<p>Lúc này project của chúng ta có cấu trúc:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-- simple-orm</span><br><span class="line">  -- Gemfile</span><br><span class="line">  -- Gemfile.lock (sinh ra sau lệnh `bundle install`)</span><br><span class="line">  -- connection.rb</span><br></pre></td></tr></table></figure>

<p>Note: Trong file <code>connection.rb</code> tôi khai báo biến conn dưới dạng biến toàn cục, để dễ ràng require trong các file khác trong project.</p>
<p><strong>STEP 3: Xây dựng Class chứa chức năng chính.</strong></p>
<p>Tạo file <code>mybase.rb</code> với nội dung như sau:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">require_relative <span class="string">'connection.rb'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyBase</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">all</span></span></span><br><span class="line">    term = <span class="string">"SELECT * FROM <span class="subst">#&#123;<span class="keyword">self</span>.name.downcase&#125;</span>"</span></span><br><span class="line">    res = $conn.exec(term)</span><br><span class="line"></span><br><span class="line">    res.each&#123; <span class="params">|row|</span></span><br><span class="line">      puts <span class="string">"<span class="subst">#&#123;row&#125;</span>\n"</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">find</span><span class="params">(id)</span></span></span><br><span class="line">    term = <span class="string">"SELECT * FROM <span class="subst">#&#123;<span class="keyword">self</span>.name.downcase&#125;</span> where id = <span class="subst">#&#123;id&#125;</span>"</span></span><br><span class="line">    res = $conn.exec(term)</span><br><span class="line"></span><br><span class="line">    res.each&#123; <span class="params">|row|</span></span><br><span class="line">      puts <span class="string">"<span class="subst">#&#123;row&#125;</span>\n"</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>require file <code>connection.rb</code> vào để sử dụng biến conn.</p>
<p>Trong class này xây dựng 2 class method là <code>all</code> và <code>find</code>, ứng với 2 phương thức trong ActiveRecord.</p>
<p><code>all</code>: Trả về toàn bộ record trong table.<br><code>find</code>: Trả về record ứng với id được truyền vào.</p>
<p><strong>STEP 4: Xây dựng class con kế thừa lớp Base ở bước 3 và sử dụng</strong></p>
<p>Trong cơ sở dữ liệu mà tôi kết nối có table tên <code>comics</code>. Tôi tạo file comics.rb có nội dung như sau:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">require_relative <span class="string">'mybase.rb'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comics</span> &lt; MyBase;</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">puts <span class="string">"All record in comics table:\n"</span></span><br><span class="line">Comics.all</span><br><span class="line">puts <span class="string">"Find record has id is 6:\n"</span></span><br><span class="line">Comics.find(<span class="number">6</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Tôi require file <code>mybase.rb</code> đã viết ở bước 3 vào file này.</p>
</li>
<li><p>Tạo class <code>Comics</code> và cho nó kế thừa class <code>MyBase</code></p>
</li>
<li><p>In ra màn hình console các dòng lệnh đã xây dựng để xem kết quả (với lệnh <code>ruby  comics.rb</code> ta sẽ chạy file comics.rb và xuất kết quả ra màn hình console).</p>
</li>
</ul>
<p>Cuối cùng project của chúng ta có dạng như sau:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-- simple-orm</span><br><span class="line">  -- Gemfile</span><br><span class="line">  -- Gemfile.lock (sinh ra sau lệnh `bundle install`)</span><br><span class="line">  -- connection.rb</span><br><span class="line">  -- mybase.rb (main chính chứa các phương thức)</span><br><span class="line">  -- comics.rb (class ứng với table comics trong csdl, kế thừa MyBase)</span><br></pre></td></tr></table></figure>

<p>Chạy file <code>comics.rb</code> với lệnh chạy ruby <code>ruby comics.rb</code> ta sẽ xem được thành quả nhỏ của quá trình xây dựng kể trên.</p>
<h1 id="4-Ket-luan"><a href="#4-Ket-luan" class="headerlink" title="4. Kết luận"></a>4. Kết luận</h1><p>Trên là một ví dụ đơn giản về ORM với ngôn ngữ Ruby, các ORM trong thực tế sẽ phức tạp và tinh tế hơn rất rất nhiều. Hy vọng qua bài viết sẽ giúp bạn đọc có được thêm kiến thức với ORM và cách nó vận hành trong framework như Rails.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hdchinh.github.io/2019/06/26/2019-06-25-xay-dung-mot-orm-don-gian-bang-ruby/" data-id="ck2wvjjb6002ngyrz1p5yeksn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/orm/" rel="tag">orm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ruby/" rel="tag">ruby</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/08/05/2019-08-05-setup-terminal-macos/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Terminal macOS Tricks
        
      </div>
    </a>
  
  
    <a href="/2019/06/24/2019-06-24-simple-rack-application/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">A Simple Rack Application</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Random/">Random</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/he-dieu-hanh/">hệ điều hành</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/rails-notes/">rails notes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ruby-notes/">ruby notes</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/ruby-notes/programming/">programming</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/til/">til</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/TIl/" rel="tag">TIl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/activerecord/" rel="tag">activerecord</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aws/" rel="tag">aws</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/carrierwave/" rel="tag">carrierwave</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/database/" rel="tag">database</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/https/" rel="tag">https</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/orm/" rel="tag">orm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/programming/" rel="tag">programming</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rack/" rel="tag">rack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rails/" rel="tag">rails</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/random/" rel="tag">random</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ruby/" rel="tag">ruby</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/secure/" rel="tag">secure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/solid/" rel="tag">solid</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/til/" rel="tag">til</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unix/" rel="tag">unix</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/TIl/" style="font-size: 12px;">TIl</a> <a href="/tags/activerecord/" style="font-size: 10px;">activerecord</a> <a href="/tags/aws/" style="font-size: 12px;">aws</a> <a href="/tags/carrierwave/" style="font-size: 10px;">carrierwave</a> <a href="/tags/database/" style="font-size: 10px;">database</a> <a href="/tags/https/" style="font-size: 10px;">https</a> <a href="/tags/orm/" style="font-size: 10px;">orm</a> <a href="/tags/programming/" style="font-size: 12px;">programming</a> <a href="/tags/rack/" style="font-size: 10px;">rack</a> <a href="/tags/rails/" style="font-size: 18px;">rails</a> <a href="/tags/random/" style="font-size: 10px;">random</a> <a href="/tags/ruby/" style="font-size: 20px;">ruby</a> <a href="/tags/secure/" style="font-size: 16px;">secure</a> <a href="/tags/solid/" style="font-size: 10px;">solid</a> <a href="/tags/til/" style="font-size: 14px;">til</a> <a href="/tags/unix/" style="font-size: 16px;">unix</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/11/12/hello-hexo/">Hello Hexo1!</a>
          </li>
        
          <li>
            <a href="/2019/09/20/2019-09-20-vscode-extension/">My Favourite Vscode Extensions</a>
          </li>
        
          <li>
            <a href="/2019/08/05/2019-08-05-setup-terminal-macos/">Terminal macOS Tricks</a>
          </li>
        
          <li>
            <a href="/2019/06/26/2019-06-25-xay-dung-mot-orm-don-gian-bang-ruby/">A Simple ORM</a>
          </li>
        
          <li>
            <a href="/2019/06/24/2019-06-24-simple-rack-application/">A Simple Rack Application</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Duy Chinh<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>